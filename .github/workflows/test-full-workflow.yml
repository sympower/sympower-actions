#Release new docker image to ECR and schema to Nexus (if contains any changes)

name: Experiment

on:
  workflow_call:
    inputs:
      gistID:
        required: true
        type: string
    outputs:
      version:
        description: Version number of the image released to ECR
        value: ${{ jobs.build.outputs.version }}

jobs:
  build:
    runs-on: ubuntu-latest
    name: "Test composite actions"
    outputs:
      version: ${{ env.VERSION }}
    steps:
      - id: setup-build-environment
        name: "Setup build environment"
        uses: sympower/sympower-actions/.github/actions/setup-build-environment@TECH-1140-split-workflow-into-composite-actions
        with:
          secrets: ${{ toJSON(secrets) }}
      - id: run-tests
        name: "Run tests"
        uses: sympower/sympower-actions/.github/actions/run-tests@TECH-1140-split-workflow-into-composite-actions
        with:
          secrets: ${{ toJSON(secrets) }}
      - id: code-analysis
        name: "Code analysis"
        uses: sympower/sympower-actions/.github/actions/code-analyzis@TECH-1140-split-workflow-into-composite-actions
        with:
          secrets: ${{ toJSON(secrets) }}
      - id: docker-image
        name: "Build docker image"
        if:
          contains('
          refs/heads/main
          refs/heads/master
          ', github.ref)
        uses: sympower/sympower-actions/.github/actions/docker-image@TECH-1140-split-workflow-into-composite-actions
        with:
          secrets: ${{ toJSON(secrets) }}
          gistID: 3b87b5f98b49b6c5a7a697a99ea4987b
      - id: upload-schema
        name: "Upload schema"
        if:
          contains('
          refs/heads/main
          refs/heads/master
          ', github.ref)
        uses: sympower/sympower-actions/.github/actions/upload-schema@TECH-1140-split-workflow-into-composite-actions
        with:
          secrets: ${{ toJSON(secrets) }}
          gistID: 3b87b5f98b49b6c5a7a697a99ea4987b
      - id: upload-pacts
        name: "Upload pacts"
        if:
          contains('
          refs/heads/main
          refs/heads/master
          ', github.ref)
        uses: sympower/sympower-actions/.github/actions/upload-pacts@TECH-1140-split-workflow-into-composite-actions
        with:
          secrets: ${{ toJSON(secrets) }}
      - id: deploy-staging
        name: "Deploy staging"
        if:
          contains('
          refs/heads/main
          refs/heads/master
          ', github.ref)
        uses: sympower/sympower-actions/.github/actions/deploy-staging@TECH-1140-split-workflow-into-composite-actions
        with:
          secrets: ${{ toJSON(secrets) }}
      - id: upload-build-artifacts
        name: "Upload build artifacts"
        uses: sympower/sympower-actions/.github/actions/upload-build-artifacts@TECH-1140-split-workflow-into-composite-actions
        with:
          secrets: ${{ toJSON(secrets) }}
